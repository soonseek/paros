// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// User Role Enum
enum Role {
    LAWYER
    PARALEGAL
    ADMIN
    SUPPORT
}

// Case Status Enum
enum CaseStatus {
    PENDING       // 대기
    IN_PROGRESS   // 진행 중
    COMPLETED     // 완료
    SUSPENDED     // 정지
    CLOSED        // 종료
}

// Transaction Nature Enum (Story 4.4: 거래 성격 판단)
enum TransactionNature {
    CREDITOR             // 채권자 관련
    COLLATERAL           // 담보 관련
    PRIORITY_REPAYMENT   // 우선변제 관련
    GENERAL              // 일반 거래
}

// User Model with Email Verification
model User {
    id                       String          @id @default(uuid())
    email                    String          @unique
    pendingEmail             String?         @unique         // Pending email change (verification in progress)
    password                 String          // bcrypt hashed password
    name                     String?         // Optional display name
    role                     Role            @default(PARALEGAL)
    isActive                 Boolean         @default(false)  // Email verification status
    tokenVersion             Int             @default(0)      // Refresh token version for rotation
    emailVerificationToken   String?         // Email verification token
    emailVerificationExpires DateTime?       // Token expiration time
    passwordResetToken       String?         // Password reset token
    passwordResetExpires     DateTime?       // Password reset token expiration
    refreshTokens            RefreshToken[]                   // User's refresh tokens
    cases                    Case[]                          // Cases owned by this user (lawyer)
    caseNotes                CaseNote[]                      // Case notes written by this user
    uploadedDocuments        Document[]                      // Documents uploaded by this user
    classificationFeedbacks  ClassificationFeedback[]         // Story 4.8: Classification feedback
    classificationErrors    ClassificationError[]            // Story 4.8: Classification errors
    savedFilters             SavedFilter[]                   // Story 5.5: Saved filters for fund flow tracking
    createdAt                DateTime        @default(now())
    updatedAt                DateTime        @updatedAt

    @@index([email])
    @@map("users")
}

// Refresh Token Model for token rotation and logout
model RefreshToken {
    id        String   @id @default(uuid())
    token     String   @unique
    userId    String
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    expiresAt DateTime
    createdAt DateTime @default(now())

    @@index([userId])
    @@index([token])
    @@map("refresh_tokens")
}

// Case Model (Bankruptcy Case)
model Case {
    id                String       @id @default(uuid())
    caseNumber        String       @unique                 // Case number (unique)
    debtorName        String                              // Debtor name (required)
    courtName         String?                             // Court name
    filingDate         DateTime?                           // Filing date
    status            CaseStatus   @default(PENDING)       // Case status
    isArchived        Boolean      @default(false)        // Archive status
    lawyerId          String                              // Owner (lawyer)
    lawyer            User         @relation(fields: [lawyerId], references: [id], onDelete: Restrict)
    notes             CaseNote[]                          // Case notes
    documents         Document[]                          // Documents uploaded for this case
    analysisResults   FileAnalysisResult[]               // Story 3.4: File structure analysis results
    transactions      Transaction[]                       // Story 3.6: Extracted transaction data
    findings          Finding[]                           // Story 4.3: Findings for this case
    createdAt         DateTime     @default(now())
    updatedAt         DateTime     @updatedAt

    @@index([caseNumber])
    @@index([lawyerId])
    @@index([status])
    @@index([isArchived])
    @@map("cases")
}

// Case Note Model
model CaseNote {
    id        String   @id @default(uuid())
    content   String                                // Note content
    caseId    String                                // Associated case
    case      Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
    authorId  String                                // Note author
    author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([caseId])
    @@index([authorId])
    @@map("case_notes")
}

// Document Model for file uploads
model Document {
    id               String   @id @default(uuid())
    caseId           String
    originalFileName String                              // Original filename
    s3Key            String   @unique                    // S3 object key (UUID)
    fileSize         Int                                 // File size in bytes
    mimeType         String                              // MIME type
    uploadedAt       DateTime @default(now())
    uploaderId       String                              // User who uploaded the file

    case             Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
    uploader         User     @relation(fields: [uploaderId], references: [id], onDelete: Cascade)
    analysisResult   FileAnalysisResult?                // Story 3.4: File structure analysis result
    transactions     Transaction[]                       // Story 3.6: Extracted transactions from this document

    @@index([caseId])
    @@index([uploaderId])
    @@map("documents")
}

// File Analysis Result Model (Story 3.4)
model FileAnalysisResult {
    id              String   @id @default(uuid())
    documentId      String   @unique                         // Document ID from Story 3.3
    caseId          String                                     // Associated Case ID

    // Analysis status
    status          String                                     // pending, analyzing, completed, failed

    // Column mapping result (JSON storage)
    columnMapping   Json     @default("{}")                     // { date: "날짜", deposit: "입금액", withdrawal: "출금액", ... }
    headerRowIndex  Int                                        // Header row index (0-based)
    totalRows       Int                                        // Total number of rows

    // Extracted raw data (JSON storage for reuse)
    extractedData   Json?                                      // { headers: string[], rows: string[][] }

    // Analysis metadata
    detectedFormat  String                                     // excel, csv, pdf
    hasHeaders      Boolean  @default(true)                    // Has header row
    confidence      Float    @default(0.0)                      // 0.0 ~ 1.0 confidence score

    // OCR metadata (for PDF files)
    ocrProvider     String?                                     // upstage, google
    ocrConfidence   Float?                                     // OCR confidence score

    // Completion timestamp
    analyzedAt      DateTime?

    // Error information
    errorMessage    String?
    errorDetails    Json?

    // Relations
    document        Document                @relation(fields: [documentId], references: [id], onDelete: Cascade)
    case            Case                    @relation(fields: [caseId], references: [id], onDelete: Cascade)
    classificationJobs ClassificationJob[]                         // Story 4.1, CRITICAL-2 FIX: AI 분류 작업

    createdAt       DateTime @default(now())
    updatedAt       DateTime @updatedAt

    @@index([caseId])
    @@index([documentId])
    @@index([status])
    @@map("file_analysis_results")
}

// Classification Job Model (Story 4.1, CRITICAL-2 FIX: AI 분류 작업 상태 추적)
model ClassificationJob {
    id               String   @id @default(uuid())
    fileAnalysisResultId String                @unique       // FileAnalysisResult ID (1:1 관계)
    status           String                              // processing, completed, failed
    progress         Int      @default(0)                // 진행률 (0 ~ total)
    total            Int                                 // 전체 거래 수
    error            String?                             // 에러 메시지

    // Relations
    fileAnalysisResult FileAnalysisResult @relation(fields: [fileAnalysisResultId], references: [id], onDelete: Cascade)

    createdAt        DateTime @default(now())
    updatedAt        DateTime @updatedAt

    @@index([fileAnalysisResultId])
    @@index([status])
    @@map("classification_jobs")
}

// Transaction Model (Story 3.6)
model Transaction {
    id               String    @id @default(uuid())
    caseId           String
    documentId       String

    // Transaction data
    transactionDate  DateTime  @db.Date                 // Transaction date
    depositAmount    Decimal?  @db.Decimal(20, 4)       // Deposit amount (optional)
    withdrawalAmount Decimal?  @db.Decimal(20, 4)       // Withdrawal amount (optional)
    balance          Decimal?  @db.Decimal(20, 4)       // Balance after transaction (optional)
    memo             String?   @db.Text                 // Transaction memo/note (optional)

    // Metadata
    rawMetadata      Json?                               // Original data preservation (JSON)
    rowNumber        Int?                                // Excel row number (optional)
    version          Int      @default(1)                 // HIGH #2: Optimistic locking version

    // Story 4.1: AI 분류 결과
    category                String?                      // 입금, 출금, 이체, 수수료, 기타
    subcategory             String?                      // 세부 분류
    confidenceScore         Float?    @default(0.0)      // 0.0 ~ 1.0 신뢰도 점수
    isManuallyClassified    Boolean?  @default(false)    // 수동 수정 여부
    aiClassificationStatus  String?                      // pending, processing, completed, failed

    // Story 4.5: 수동 분류 수정
    originalCategory        String?   @db.Text           // 원본 AI 분류 카테고리 (복원용)
    originalSubcategory     String?   @db.Text           // 원본 AI 분류 서브카테고리 (복원용)
    originalConfidenceScore Float?                       // 원본 AI 신뢰도 점수 (복원용) - CRITICAL #1 fix
    manualClassificationDate DateTime?                   // 수동 수정 일시
    manualClassifiedBy      String?                      // 수동 수정 사용자 ID

    // Story 4.3: 중요 거래 식별
    importantTransaction       Boolean?  @default(false)  // 중요 거래 여부
    importantTransactionType   String?                     // LOAN_EXECUTION, REPAYMENT, COLLATERAL, SEIZURE
    importantTransactionKeywords String?                   // 매칭된 키워드 (JSON 배열)

    // Story 4.4: 거래 성격 판단
    transactionNature   TransactionNature?   // 거래 성격 (CREDITOR, COLLATERAL, PRIORITY_REPAYMENT, GENERAL)
    creditorName        String?   @db.Text   // 채권자명 (채권자 관련 거래)
    collateralType      String?              // 담보 유형 (담보 관련 거래: 저당권, 질권, 유치권)

    // Relations
    case             Case             @relation(fields: [caseId], references: [id], onDelete: Cascade)
    document         Document         @relation(fields: [documentId], references: [id], onDelete: Cascade)
    findings         Finding[]                          // Story 4.3: Finding 관계 (일대다)
    tags             TransactionTag[]                   // Story 4.6: 태그 관계 (일대다)
    feedbacks        ClassificationFeedback[]          // Story 4.8: Classification feedback (일대다)
    errors           ClassificationError[]             // Story 4.8: Classification errors (일대다)

    // Epic 5: 자금 흐름 추적 관계
    upstreamRelations    TransactionRelation[] @relation("UpstreamRelations")    // 상류(출처) 거래 관계
    downstreamRelations  TransactionRelation[] @relation("DownstreamRelations")  // 하류(사용처) 거래 관계
    upstreamChains      TransactionChain[]     @relation("UpstreamChains")      // 상류 체인 (일대다)
    downstreamChains    TransactionChain[]     @relation("DownstreamChains")    // 하류 체인 (일대다)

    createdAt        DateTime  @default(now())
    updatedAt        DateTime  @updatedAt

    // CRITICAL-1 FIX: Add unique constraint to prevent duplicate transactions
    @@unique([documentId, transactionDate, depositAmount, withdrawalAmount])
    @@index([caseId])
    @@index([documentId])
    @@index([transactionDate])
    @@index([category])
    @@index([aiClassificationStatus])
    @@index([importantTransaction])
    @@index([importantTransactionType])
    @@index([transactionNature])  // Story 4.4: 거래 성격 필터링 최적화
    @@index([isManuallyClassified])  // Story 4.5: 수동 수정 필터링 최적화
    @@map("transactions")
}

// Finding Model (Story 4.3, Epic 6: 발견사항 관리)
model Finding {
    id                String      @id @default(cuid())
    caseId            String
    case              Case        @relation(fields: [caseId], references: [id], onDelete: Cascade)
    transactionId     String?
    transaction       Transaction? @relation(fields: [transactionId], references: [id], onDelete: SetNull)

    // Epic 6: 다중 거래 연결 지원 (자동 발견사항 식별용)
    relatedTransactionIds String[]   // JSON array: 관련된 모든 거래 ID
    relatedCreditorNames  String?   // JSON array: 관련 채권자 이름 목록

    findingType       String      // IMPORTANT_TRANSACTION, PRIORITY_REPAYMENT, COLLATERAL_CHANGE, etc.
    title             String
    description       String?     @db.Text
    severity          String      @default("INFO") // INFO, WARNING, CRITICAL
    priority          String?     // Story 6.5: "HIGH", "MEDIUM", "LOW" or null (사용자 지정 중요도)
    isResolved        Boolean     @default(false)
    resolvedAt        DateTime?

    createdAt         DateTime    @default(now())
    updatedAt         DateTime    @updatedAt

    // Epic 6: FindingNote relation (Story 6.3)
    notes             FindingNote[]

    @@index([caseId])
    @@index([transactionId])
    @@index([findingType])
    @@index([severity])
    @@index([priority])           // Story 6.5: priority 인덱스 추가
    @@index([isResolved])
    @@map("findings")
}

// FindingNote Model (Epic 6, Story 6.3: 발견사항 메모 추가)
model FindingNote {
    id          String   @id @default(cuid())
    findingId   String
    content     String   @db.Text
    createdBy   String
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    finding     Finding  @relation(fields: [findingId], references: [id], onDelete: Cascade)

    @@index([findingId])
    @@map("finding_notes")
}

// Tag Model (Story 4.6: 태그 추가 및 삭제)
model Tag {
  id          String        @id @default(uuid())
  name        String        @unique @db.Text
  createdAt   DateTime      @default(now())
  createdBy   String?
  transactions TransactionTag[]

  @@index([name])
  @@map("tags")
}

// TransactionTag Model (Story 4.6: Transaction-Tag Many-to-Many Join Table)
model TransactionTag {
  id            String      @id @default(uuid())
  transactionId String
  tagId         String
  createdAt     DateTime    @default(now())
  createdBy     String?

  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  tag           Tag         @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([transactionId, tagId])
  @@index([transactionId])
  @@index([tagId])
  @@map("transaction_tags")
}

// Audit Log Model (Story 2.1, Story 4.5 CRITICAL #2)
model AuditLog {
    id          String   @id @default(cuid())
    userId      String                                  // User who performed the action
    action      String                                  // CREATE, UPDATE, DELETE, RESTORE, etc.
    entityType  String                                  // TRANSACTION_CLASSIFICATION, CASE, DOCUMENT, etc.
    entityId    String                                  // ID of the affected entity
    changes     Json?                                   // JSON object with before/after values
    ipAddress   String?                                 // Client IP address
    userAgent   String?   @db.Text                      // Client user agent
    createdAt   DateTime  @default(now())

    @@index([userId])
    @@index([action])
    @@index([entityType])
    @@index([entityId])
    @@index([createdAt])
    @@map("audit_logs")
}

// Story 4.8: Learning Feedback Loop Models

// Classification Error Types Enum
enum ClassificationErrorType {
    WRONG_CATEGORY   // 잘못된 카테고리
    MISSED           // 누락된 분류
    LOW_CONFIDENCE   // 신뢰도 부정확
}

// Classification Rule Pattern Types Enum
enum ClassificationRulePatternType {
    KEYWORD       // 키워드 기반
    AMOUNT_RANGE  // 금액 범위 기반
    CREDITOR      // 거래처 기반
}

// Classification Feedback Model
model ClassificationFeedback {
    id                    String      @id @default(uuid())
    transactionId         String
    transaction           Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

    // Original AI classification
    originalCategory      String?     @db.Text
    originalSubcategory   String?     @db.Text
    originalConfidence   Float?

    // User correction
    userCategory          String?     @db.Text
    userSubcategory       String?     @db.Text

    feedbackDate          DateTime    @default(now())
    userId                String
    user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)

    createdAt             DateTime    @default(now())
    updatedAt             DateTime    @updatedAt

    @@index([transactionId])
    @@index([feedbackDate])
    @@index([userId])
    @@index([userCategory])
    @@map("classification_feedbacks")
}

// Classification Rule Model
model ClassificationRule {
    id                String                     @id @default(uuid())
    pattern           String                     // Pattern (keyword, amount range, creditor name)
    patternType       ClassificationRulePatternType // KEYWORD, AMOUNT_RANGE, CREDITOR
    category          String                     // Mapped category
    subcategory       String?                    // Mapped subcategory (optional)
    confidence        Float        @default(0.9)  // Rule confidence score
    applyCount        Int          @default(0)     // Number of times rule was applied
    successCount      Int          @default(0)     // Number of successful applications
    lastAppliedAt     DateTime?                  // Last application timestamp
    isActive          Boolean      @default(true)  // Whether rule is active

    createdAt         DateTime    @default(now())
    updatedAt         DateTime    @updatedAt

    @@index([patternType])
    @@index([confidence])
    @@index([applyCount])
    @@index([isActive])
    @@map("classification_rules")
}

// Classification Error Report Model
model ClassificationError {
    id                String                   @id @default(uuid())
    transactionId     String
    transaction       Transaction             @relation(fields: [transactionId], references: [id], onDelete: Cascade)

    errorType         ClassificationErrorType  // WRONG_CATEGORY, MISSED, LOW_CONFIDENCE
    description       String      @db.Text     // Error description
    severity          String                   // LOW, MEDIUM, HIGH

    reportedAt        DateTime    @default(now())
    userId            String
    user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
    resolved          Boolean     @default(false)

    createdAt         DateTime    @default(now())
    updatedAt         DateTime    @updatedAt

    @@index([transactionId])
    @@index([errorType])
    @@index([severity])
    @@index([resolved])
    @@index([userId])
    @@map("classification_errors")
}

// Epic 5: 자금 흐름 추적 (Fund Flow Tracking)

// Transaction Relation Type Enum
enum TransactionRelationType {
    DIRECT_TRANSFER    // 직접 이체 (명확한 연결)
    PROBABLE_TRANSFER  // 추정 이체 (금액/날짜 유사도 기반)
    RELATED           // 관련 거래 (같은 채권자/담보)
}

// TransactionRelation Model (거래 간 연결 관계)
model TransactionRelation {
    id              String                   @id @default(uuid())
    caseId          String                                       // Case ID (필터링 최적화)
    sourceTxId      String                                       // 상류(출처) 거래 ID
    sourceTx        Transaction             @relation("DownstreamRelations", fields: [sourceTxId], references: [id], onDelete: Cascade)
    targetTxId      String                                       // 하류(사용처) 거래 ID
    targetTx        Transaction             @relation("UpstreamRelations", fields: [targetTxId], references: [id], onDelete: Cascade)

    relationType    TransactionRelationType @default(DIRECT_TRANSFER)
    confidence      Float                   @default(1.0)         // 연결 신뢰도 (0.0 ~ 1.0)
    matchReason     String?     @db.Text                        // 연결 사유 (금액 일치, 날짜 근접, 채권자 일치 등)
    distance        Int          @default(1)                    // 거래 간 거리 (1: 직접 연결, 2+: 간접 연결)

    createdAt       DateTime    @default(now())
    updatedAt       DateTime    @updatedAt

    @@unique([sourceTxId, targetTxId])                           // 중복 방지
    @@index([caseId])
    @@index([sourceTxId])
    @@index([targetTxId])
    @@index([relationType])
    @@index([confidence])
    @@map("transaction_relations")
}

// TransactionChain Model (사전 계산된 자금 흐름 체인)
model TransactionChain {
    id              String   @id @default(uuid())
    caseId          String                                // Case ID (필터링 최적화)
    startTxId       String                                // 체인 시작 거래 ID
    startTx         Transaction @relation("UpstreamChains", fields: [startTxId], references: [id], onDelete: Cascade)
    endTxId         String                                // 체인 끝 거래 ID
    endTx           Transaction @relation("DownstreamChains", fields: [endTxId], references: [id], onDelete: Cascade)

    chainType       String                                // UPSTREAM(상류 추적), DOWNSTREAM(하류 추적)
    chainDepth      Int          @default(1)              // 체인 깊이 (최대 5레벨)
    path            String       @db.Text                 // 거래 경로 (CSV: "tx1,tx2,tx3,tx4,tx5")
    totalAmount     Decimal?     @db.Decimal(20, 4)       // 총 금액 합계

    createdAt       DateTime     @default(now())
    updatedAt       DateTime     @updatedAt

    @@index([caseId])
    @@index([startTxId])
    @@index([endTxId])
    @@index([chainType])
    @@index([chainDepth])
    @@map("transaction_chains")
}

// SavedFilter Model (Story 5.5: 추적 필터링 - 필터 저장, Story 8.2: 다차원 검색 필터 저장)
model SavedFilter {
    id          String   @id @default(uuid())
    userId      String
    name        String
    filters     Json                              // FundFlowFilters 또는 ExtendedSearchFilters 직렬화
    filterType  String?                          // SEARCH (Story 8.2), FUND_FLOW (Story 5.5), null for legacy
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
    user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([userId, name])
    @@index([userId])
    @@index([filterType])
    @@map("saved_filters")
}

// System Settings Model - Admin configurable settings
model SystemSetting {
    id        String   @id @default(uuid())
    key       String   @unique                   // Setting key (e.g., "AI_PROVIDER", "UPSTAGE_API_KEY")
    value     String?  @db.Text                  // Encrypted value
    category  String   @default("GENERAL")       // GENERAL, AI, EMAIL, etc.
    isEncrypted Boolean @default(false)          // Whether value is encrypted
    updatedBy String?                            // User who last updated
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([key])
    @@index([category])
    @@map("system_settings")
}
