<analysis>**original_problem_statement:**
The user wants to enhance a cloned GitHub repository (). The primary goal is to build a robust, template-based data extraction system for bank and credit card statements.

PRODUCT REQUIREMENTS:
1.  **Template-Based Parsing:**
    *   An admin page to manage Transaction Templates.
    *   Templates define identifiers and a column schema for data extraction.
    *   The system must match uploaded PDFs to templates or fall back to a general LLM analysis.
2.  **AI-Assisted Template Creation:**
    *   A feature to create a template draft by uploading a sample PDF/screenshot.
3.  **New Quick Action Features (Case Detail Page):**
    *   **Loan Fund Usage Report:** A modal to trace how loan funds were used and generate an Excel report. This has been significantly overhauled into a multi-step process.
    *   **Amount Filter Report:** A modal to filter transactions by an amount threshold and export to Excel.
4.  **Enhanced Upload Flow:**
    *   Show a modal for manual template selection on a match fail.
    *   Implement chunking for large files.
    *   Perform a quick pre-analysis for user confirmation, showing matched template and parsed data preview.
    *   **New:** Allow re-parsing the sample data with a different template directly from the confirmation modal.
5.  **LLM Chat Enhancement:**
    *   The AI chat assistant was hitting token limits by processing all transactions. It needs to be refactored to query the database intelligently instead of receiving the entire dataset in the prompt.
6.  **Bug Fixes & UX Improvements:**
    *   Resolve duplicate row parsing.
    *   Fix transaction count discrepancies.
    *   Improve Delete by Document to be atomic.
    *   Fix various UI issues (modal widths, table columns, scrollability).
    *   **New:** Implement account transfer detection where funds moved between accounts are not counted as used but as moved.

**User's preferred language**: Korean (한국어)

**what currently exists?**
The application is a full-stack Next.js/tRPC/Prisma app for financial statement analysis. This session introduced several major features and refactors:
-   **AI Chat with Function Calling:** The AI chat assistant (, ) was completely refactored. Instead of receiving all transaction data and hitting token limits, it now uses OpenAI's Function Calling feature. The LLM is provided with function definitions (, , etc.) and summary statistics, allowing it to generate database queries on the fly to answer user questions. Support for gpt-5 (mapped to  model) was also added.
-   **Comprehensive Loan Tracking Modal:** The Loan Fund Usage Report feature was overhauled into a multi-step modal ().
    -   **Step 1:** Users can either auto-detect suspected loan deposits or search for them by keyword.
    -   **Step 2:** A list of potential loan deposits is presented with a confidence score, and users can select the correct ones via checkbox.
    -   **Step 3:** A tabbed interface shows a detailed fund usage report for each selected loan, with individual Excel export buttons.
-   **Account Transfer Detection:** The loan tracking logic in  now identifies inter-account transfers. If a withdrawal from one account matches an deposit in another account on the same day for the same amount, it's marked as an 이동 (Move) and does not decrease the remaining loan balance.
-   **Template Sample File Storage:** The  schema was extended to store a sample file (, , ). The template admin page now requires a file to be analyzed for creating new templates, and this file is stored in S3. The template matching modal now shows a preview of this sample file.
-   **Live Re-Parsing in Modal:** The template matching confirmation modal () now has a Retry Parsing button. If the initial template match is incorrect, the user can select another template and re-run the parsing on the sample data to see an updated preview without re-uploading.
-   **UI/UX Fixes:** Several UI bugs were fixed, including scrollability issues in modals, incorrect Excel downloads, and refining the sorting logic for transaction tables.

**Last working item**:
-   **Last item agent was working:** The user requested a feature to re-parse the initial 3-page analysis with a different template directly within the template match confirmation modal. The agent added a 결과 파싱 재시도 (Retry Parsing Result) button and a new backend tRPC endpoint () to support this.
-   **Status:** USER VERIFICATION PENDING
-   **Agent Testing Done:** N
-   **Which testing method agent to use?** Frontend testing agent. The test should involve:
    1.  Uploading a file to trigger the .
    2.  Ensuring it shows an initial (potentially incorrect) parsing result.
    3.  Switching to the Select Other Template view.
    4.  Selecting a different template from the list.
    5.  Clicking the 결과 파싱 재시도 button.
    6.  Verifying the sample data table updates with new results based on the selected template.
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1: Incorrect parsing due to template configuration (P0)**
-   **Issue 2: Incorrect Excel file downloaded from Loan Tracking Modal (P1)**
-   **Issue 3: Persistent complex/nested table parsing failures (P1)**
-   **Issue 4: Un-applied database schema migration (P2)**

**Issues Detail:**
-   **Issue 1:**
    -   **Description**: The user reported that a transaction ( - withdrawal) was being incorrectly classified as a deposit. Through logging, the agent determined the cause was an incorrect template configuration. The user's template pointed to the wrong column index for .
    -   **Attempted fixes**: The agent added extensive logging to the parsing logic. This helped diagnose the issue as a data problem, not a code bug. The agent explained to the user that they need to correct the column index in their template settings (from index  to ).
    -   **Next debug checklist**: This is pending user action. The next step is for the user to modify their template configuration as advised.
    -   **Why fix this issue?** This is a critical blocker for reliable data extraction for that specific template.
    -   **Status**: BLOCKED (Pending user action)
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Backend (data integrity).
-   **Issue 2:**
    -   **Description**: In the loan tracking modal (Step 3), the user reported that clicking the Excel Download button for a specific tab was downloading the results from the Amount Filter modal instead.
    -   **Attempted fixes**: The agent reviewed the code, found no obvious function name collisions, and suspected a potential browser caching issue. The agent advised the user to perform a hard refresh (Ctrl+Shift+R).
    -   **Next debug checklist**:
        1.  Ask the user to confirm if a hard refresh solved the issue.
        2.  If not, add unique  attributes to both download buttons.
        3.  Use the frontend testing agent to specifically click the correct button and verify the downloaded file's name/content.
    -   **Why fix this issue?** The export feature is unusable if it downloads the wrong data.
    -   **Status**: USER VERIFICATION PENDING
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** Frontend.
-   **Issue 3:**
    -   **Description**: The application still struggles with certain complex PDF table structures (/, multi-line rows).
    -   **Attempted fixes**: Previous work included heuristics to find the main header row, which helps. No new work was done on this in the current session.
    -   **Next debug checklist**: No immediate action is needed until a new, failing PDF format is provided by the user.
    -   **Why fix this issue?** It's fundamental to the app's ability to handle diverse document formats.
    -   **Status**: NOT STARTED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Backend.
-   **Issue 4:**
    -   **Description**: The  file has been modified (added , etc. to  and  constraint in a previous session), but the changes have not been applied to the database.
    -   **Attempted fixes**: The agent correctly identified that this requires a command to be run in the user's local environment.
    -   **Next debug checklist**: The agent must remind the user to run Prisma schema loaded from prisma/schema.prisma
Datasource "db": PostgreSQL database "paros", schema "public" at "127.0.0.1:5432" in their local terminal to synchronize the database schema. This is a blocking action for new template features to work correctly.
    -   **Why fix this issue?** Ensures data integrity and enables the new sample file storage feature.
    -   **Status**: BLOCKED (Pending user action)
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** Backend.

**In progress Task List**:
-   None.

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **(P1)** Enhance Transaction Table UI: Add  /  prefixes to the amount values in the transaction table.
-   **Future Tasks:**
    -   **(P2)** Full Mobile Optimization.
    -   **(P2)** Scheduled Batch Jobs ().
    -   **(P2)** Template Success Rate Tracking: Implement logic to automatically track and display how often each template successfully parses a document.

**Completed work in this session**
-   **AI Chat Refactor**: Re-architected the AI chat to use OpenAI Function Calling, eliminating token limit errors and enabling database queries.
-   **Loan Tracking Modal Overhaul**: Rebuilt the loan tracking feature into a 3-step guided workflow with auto-detection, manual selection, and a tabbed results view.
-   **Account Transfer Logic**: Implemented backend logic to detect and correctly handle inter-account fund transfers, preventing them from being counted as used funds.
-   **Template Sample Storage**: Extended the Prisma schema and backend APIs to allow storing and previewing a sample file for each template.
-   **Live Re-Parsing Feature**: Added a Retry Parsing button to the upload confirmation modal, allowing users to test different templates on the fly.
-   **Bug Fix: S3 Upload**: Fixed a bug where the  function was called with incorrect parameters in the template router, causing S3 uploads to fail.
-   **Bug Fix: List Refresh**: Fixed a bug where deleting a document did not refresh the document list dropdown by invalidating the correct tRPC query ().
-   **Bug Fix: Loan Detection & Sorting**: Improved the confidence scoring for loan detection and updated the sorting logic to place Move transactions first within the same day.
-   **UI/UX Fixes**:
    -   Resolved multiple table scrollability issues in modals.
    -   Added Korean labels for column roles in previews.
    -   Improved parsing for templates using separate  and  columns.
    -   Added the  Shadcn component and its dependencies.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: Incorrect Excel Download:** As described in the , the user reported the loan tracking modal downloads the wrong Excel file. The agent's suggestion to clear cache has not been verified.

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork:** Incorrect 'memo' (비고) parsing.
-   **Recurrence count:** High.
-   **Status:** BLOCKED. The agent diagnosed it as a user-side template configuration error and provided the solution (correct the column index). Awaiting user action.

**Code Architecture**


**Key Technical Concepts**
-   **Frameworks**: Next.js, tRPC, Prisma, Tailwind CSS
-   **Database**: PostgreSQL
-   **AI**: OpenAI Function Calling, Upstage Solar OCR
-   **PDF Processing**:  for chunking

**key DB schema**
-   :
    -   Added , , .
    -   The  constraint and the new fields **have not been applied to the database**. User action (Prisma schema loaded from prisma/schema.prisma
Datasource "db": PostgreSQL database "paros", schema "public" at "127.0.0.1:5432") is required.

**All files of reference**
-   : The new Function Calling implementation for the AI assistant.
-   : The completely redesigned UI for loan tracking.
-   : Contains the new backend logic for loan detection, tracking, and inter-account transfers.
-   : The UI for the new re-parsing feature.
-   : The  endpoint.
-   : Contains the schema changes that need to be pushed to the DB.

**Critical Info for New Agent**
-   **DB Migration Required:** The user **must** run Prisma schema loaded from prisma/schema.prisma
Datasource "db": PostgreSQL database "paros", schema "public" at "127.0.0.1:5432" in their local environment. The database schema is out of sync with . New features related to template sample files will not work without this.
-   **AI Chat Architecture:** The AI chat no longer accepts the full transaction list. It uses tRPC Function Calling via . Do not try to pass large data payloads to it.
-   **User Environment:** The user has stated that the agent cannot log in or use screenshot testing, as the project runs exclusively in their local environment. All verification must be done by asking the user to test and report back.
-   **S3 Access:** The user has confirmed that S3 access works from their local environment. Any S3 errors are likely code bugs (like the incorrect function signature that was fixed), not environment configuration issues.

**documents and test reports created in this job**
-   None.

**Last 10 User Messages and any pending HUMAN messages**
10. **User**: The loan tracking modal needs an overhaul: auto-detect loans, let me select them, then show results in tabs. **(Status: COMPLETED)**
9.  **User**: Also add a keyword search for loans as an option. **(Status: COMPLETED)**
8.  **User**: The loan tracking results table (step 2) doesn't scroll. **(Status: COMPLETED)**
7.  **User**: Add the memo to the tab titles in the loan tracking results (step 3). **(Status: COMPLETED)**
6.  **User**: Critical: Fund transfers between my own accounts should not be counted as used loan funds. They should be marked as a Move. **(Status: COMPLETED)**
5.  **User**: Loan selection (step 2) still doesn't scroll. Also, sort the results by confidence and improve the confidence scoring. **(Status: COMPLETED)**
4.  **User**: The Excel download in the loan tracking results (step 3) downloads the wrong file. Also, don't limit the table to 10 rows. And sort Move transactions to the top for the same day. **(Status: IN PROGRESS - Excel issue pending verification, others complete)**
3.  **User**: When I select a different template in the upload confirmation modal, I want a button to re-parse the sample data and see the new result immediately. **(Status: COMPLETED, PENDING USER VERIFICATION)**
2.  **User**: A transaction is being incorrectly parsed as a deposit when it's a withdrawal. **(Status: BLOCKED - Diagnosed as template config issue, awaiting user action)**
1.  **User**: The AI chat is hitting a 429 rate limit error. Can we use GPT-5? **(Status: COMPLETED)**

**Project Health Check:**
-   **Broken**: The database schema is out of sync with . This is a critical blocker for template-related features and must be resolved by the user.

**3rd Party Integrations**
-   **OpenAI**: GPT-4o-mini and GPT-5 () via Function Calling for AI Chat.
-   **Upstage Solar**: For core PDF OCR and layout analysis.
-   **pdf-lib**: Used for splitting large PDF files.

**Testing status**
-   **Testing agent used after significant changes:** NO
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created**: []
-   **Known regressions**: None.

**Credentials to test flow:**
-   **Agent cannot test.** The user has explicitly stated that login and screenshot testing are not possible as the application runs in a local-only environment. All functionality must be verified by the user.

**What agent forgot to execute**
-   The agent did not (and could not) run the database migration (Prisma schema loaded from prisma/schema.prisma
Datasource "db": PostgreSQL database "paros", schema "public" at "127.0.0.1:5432"). It correctly identified this as a user-side action and must remind the user to perform it.</analysis>
